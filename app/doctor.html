<!DOCTYPE HTML>
<html>

<head>
	<title>Врачу</title>
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="assets/css/main.css" />
</head>

<body class="left-sidebar is-preload">
	<div id="page-wrapper">

		<!-- Header -->
		<div id="header-wrapper">
			<div id="header" class="container">

				<!-- Logo -->
				<h1 id="logo">
					<a href="index.html">HISS</a>
				</h1>

				<!-- Nav -->
				<nav id="nav">
					<ul>
						<li>
							<a href="instruction.html">Инструкция</a>
						</li>
						<li>
							<a href="patient.html">Пациенту</a>
						</li>
						<li class="break">
							<a href="doctor.html">Врачу</a>
						</li>
						<li>
							<a href="insurance_company.html">Страховой компании</a>
						</li>
					</ul>
				</nav>

			</div>
		</div>

		<!-- Main -->
		<div class="wrapper">
			<div class="container" id="main">
				<div class="row gtr-150">
					<!-- Content -->
					<article id="content">
						<header>
							<h2>HISS. Врачу</h2>
							<p>Легкий контроль доступа и просмотр записей.
								<ul>
									<li>Только проверенные пациенты с валидной страховкой.</li>
									<li>Удобное соглашение с пациентами на предоставление медицинских услуг.</li>
									<li>Защищенная и достоверная база записей о пациентах, добавление новых записей о посещениях.</li>
								</ul>
							</p>
						</header>
						<h3>Перед выполнением всех операций удостоверьтесь, что у вас работает Metamask.</h3>
						<br>
						<hr>
						<br>
						<div class="4u 12u$(small)">
							<p>Для добавления новой записи о пациенте:</p>
							<p>1. Введите eth адрес пациента</p>
							<p>2. Введите текст записи в поле</p>
							<p>3. Нажмите «Добавить запись»</p>
							<input type="text" name="pAddressToAdding" id="pAddressToAdding1" value="" placeholder="Введите eth адрес пациента" size="45">
							<br>
							<input type="text" name="note" id="note" value="" placeholder="Введите запись" size="45">
							<br>
							<button id="buttonpAddNote">Добавить запись</button>
							<br>
							<br>
							<hr>
							<br>
							<p>Для того, чтобы узнать, сколько записей о пациенте содержится в базе:</p>
							<p>1. Введите eth адрес пациента</p>
							<p>2. Нажмите «Количество записей пациента»</p>
							<input type="text" name="pAddressToAdding" id="pAddressToAdding2" value="" placeholder="Введите eth адрес пациента" size="45">
							<br>
							<button id="buttonNumberOfNotes">Количество записей пациента</button>
							<br>
							<br>
							<hr>
							<br>
							<p>Для поиска конкретной записи о пациенте:</p>
							<p>1. Введите eth адрес пациента</p>
							<p>2. Введите номер записи</p>
							<p>3. Нажмите «Найти запись»</p>
							<input type="text" name="pAddressToAdding" id="pAddressToAdding3" value="" placeholder="Введите eth адрес пациента" size="45">
							<br>
							<input type="text" name="noteNumber" id="noteNumber" value="" placeholder="Введите номер записи" size="45">
							<br>
							<p>
								<textarea class="form-control" placeholder="Приватный ключ пациента для дешифрации записей" id="pPrivateKey" rows="5" width="45"></textarea>
							</p>
							<button id="buttonHashes">Найти запись</button>
							<br>
							<br>
							<hr>
						</div>
					</article>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<div id="footer-wrapper">
		<div id="footer" class="container">
			<header class="major">
				<h2>HISS объединяет пациентов, медицинские учреждения и страховые компании.</h2>
				<p>
					Подлинность и неизменяемость данных гарантируется технологией блокчейн.
					<br /> Вся информация обезличена и хранится в зашифрованном виде в распределенной базе.
				</p>
			</header>

		</div>
		<div id="copyright" class="container">
			<ul class="menu">
				<li>&copy; HISS Blockchain Based. All rights reserved. 2018</li>
			</ul>
		</div>
	</div>
	</div>

	<!-- Scripts -->
	<script src="assets/js/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/2.3.1/jsencrypt.min.js"></script>
	<script src="./main.js"></script>
	<script>
		if (typeof web3 === 'undefined') {
			alert("Включите Metamask")
		}
		else {
			const address = "0x262178ecdcbea581c06dc1629a39a40757ee3e55";
			const ABI = [
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						},
						{
							"name": "digitalSign",
							"type": "string"
						}
					],
					"name": "addHospital",
					"outputs": [],
					"payable": true,
					"stateMutability": "payable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						}
					],
					"name": "addInsuranceCompany",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						},
						{
							"name": "note",
							"type": "string"
						}
					],
					"name": "addNewNote",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						},
						{
							"name": "publicKey",
							"type": "string"
						},
						{
							"name": "firstNote",
							"type": "string"
						}
					],
					"name": "addPatient",
					"outputs": [],
					"payable": true,
					"stateMutability": "payable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						}
					],
					"name": "consentToAddData",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "addr",
							"type": "address"
						},
						{
							"name": "flag",
							"type": "bool"
						}
					],
					"name": "setInsuranceStatus",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "_min",
							"type": "uint256"
						},
						{
							"name": "_max",
							"type": "uint256"
						}
					],
					"name": "setLimits",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "amount",
							"type": "uint256"
						}
					],
					"name": "withdrawal",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "constructor"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						},
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "accessByHospital",
					"outputs": [
						{
							"name": "",
							"type": "bool"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [],
					"name": "balance",
					"outputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						},
						{
							"name": "",
							"type": "uint256"
						}
					],
					"name": "hashes",
					"outputs": [
						{
							"name": "",
							"type": "string"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "hospitalSign",
					"outputs": [
						{
							"name": "",
							"type": "string"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "isInsuranceActive",
					"outputs": [
						{
							"name": "",
							"type": "bool"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "keyByAddress",
					"outputs": [
						{
							"name": "",
							"type": "string"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [],
					"name": "max",
					"outputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [],
					"name": "min",
					"outputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "numberOfNotes",
					"outputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [],
					"name": "owner",
					"outputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "typeByAddress",
					"outputs": [
						{
							"name": "",
							"type": "uint8"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				}
			];
			var HissContract = web3.eth.contract(ABI).at(address);
			web3.eth.getAccounts(function (err, accs) {
				if (err != null) {
					alert("There was an error fetching your accounts.");
					return;
				}

				if (accs.length == 0) {
					alert("Couldn't get any accounts! Make sure your Ethereum client is configured correctly.");
					return;
				}

				accounts = accs;
				account = accounts[0];
				$("#buttonpAddNote").click(function () {
					HissContract.keyByAddress.call(
						$("#pAddressToAdding").val(),
						(e, r) => {
							var crypt = new JSEncrypt();
							crypt.setPublicKey(r);
							var encryptedNote = crypt.encrypt($('#note').val());
							HissContract.addNewNote(
								$("#pAddressToAdding1").val(),
								encryptedNote,
								(e, myTxHash) => {
									web3.eth.filter('latest', function (error, result) {
										web3.eth.getBlock(result, (e, b) => {
											var t = b.transactions
											for (var i = 0; i < t.length; i++)
												if (t[i] == myTxHash) {
													alert("Запись добавлена")
												}
										})
									})
								})
						});
				});
				$("#buttonNumberOfNotes").click(function () {
					HissContract.numberOfNotes.call(
						$("#pAddressToAdding2").val(),
						(e, r) => {
							alert("Количество записей у пациента: " + r)
						})
				});
				$("#buttonHashes").click(function () {
					HissContract.hashes.call(
						$("#pAddressToAdding3").val(),
						$("#noteNumber").val(),
						(e, r) => {
							var crypt = new JSEncrypt();
							crypt.setPrivateKey($('#pPrivateKey').val());
							var uncrypted = crypt.decrypt(r);
							alert(uncrypted);
						})
				});
			});
		}
	</script>
</body>

</html>